@startuml
title UC09 - Get a list of all devices in a house, grouped by device functionality types. It must include device location.

autonumber

!pragma teoz true

box " <<SubSystem>>\n  <<Container>>\n    :Backend " #DarkGrey
box " <<Component>>\n    :Server" #LightGrey
participant ":Router" as Router <<Component>>

participant ":HouseControllerWeb" as US09Ctrl <<Component>>
participant ":ListAllDevicesInHouseByFunctionalityService" as HouseService <<Component>>
participant "mainSensorMap:\nMap<SensorFunctionalityID, \nMap<RoomID, DeviceID>>" as mainSensorMap
participant ":SensorRepository" as SensorRepository <<Component>>
participant ":MapperSensorDataModel" as MapperSensorDataModel <<Component>>
participant "sensor:Sensor" as Sensor
participant ":DeviceRepository" as DeviceRepository <<Component>>
participant ":MapperDeviceDataModel" as MapperDeviceDataModel <<Component>>
participant "device:Device" as Device

participant ":DB Driver" as DBDriver <<Component>>


[o-> Router: GET api/houses/{id}/devices
activate Router

'SECTION 1: CALL TO CONTROLLER AND CONTROLLER TO SERVICE'
Router -> US09Ctrl: GET getListOfDevicesByFunctionality()
activate US09Ctrl
US09Ctrl -> HouseService: devicesGroupedByFunctionalityAndLocation()
activate HouseService
'END SECTION'

'SECTION 2: ITERATE THROUGH SENSORS AND GROUP SENSORS BY FUNCTIONALITY'
HouseService -> HouseService: sensorFunctionalityMap()
    activate HouseService
        HouseService --> mainSensorMap**: <<creates>>
        HouseService -> SensorRepository: findAllEntities()
        activate SensorRepository
        SensorRepository -> DBDriver: findAll()
        activate DBDriver
        DBDriver ->o]: DATABASE QUERY
        DBDriver <--o]: QUERY RESPONSE
        DBDriver --> SensorRepository: Iterable<SensorDataModel> sensorListDataModel
        deactivate DBDriver
        SensorRepository -> MapperSensorDataModel: toDomainList(factorySensor, sensorListDataModel)
        activate MapperSensorDataModel
        MapperSensorDataModel --> SensorRepository: Iterable<Sensor> sensorList
        deactivate MapperSensorDataModel
        SensorRepository --> HouseService: Iterable<Sensor> sensorList
        deactivate SensorRepository
    'SECTION 2.1: LOOPING THROUGH EACH SENSOR'
    loop for each Sensor in sensors
        HouseService -> Sensor: getSensorFunctionalityID()
        activate Sensor
        Sensor --> HouseService: SensorFunctionalityID sensorFunctionalityID
        HouseService -> Sensor: getDeviceID()
        Sensor --> HouseService: DeviceID deviceID
        deactivate Sensor
        HouseService -> DeviceRepository: findEntityByID(deviceID)
        activate DeviceRepository
        DeviceRepository -> DBDriver: findByID(deviceID)
        activate DBDriver
        DBDriver ->o]: DATABASE QUERY
        DBDriver <--o]: QUERY RESPONSE
        DBDriver --> DeviceRepository: DeviceDataModel deviceDataModel
        deactivate DBDriver
        DeviceRepository -> MapperDeviceDataModel: toDomain(factoryDevice, deviceDataModel)
        activate MapperDeviceDataModel
        MapperDeviceDataModel --> DeviceRepository:  device
        deactivate MapperDeviceDataModel
        DeviceRepository --> HouseService:  device
        deactivate DeviceRepository
        HouseService -> Device: getRoomID()
        activate Device
        Device --> HouseService: RoomID roomID
        deactivate Device
        note over HouseService: On Step <b>28</b> make sure not to overwrite\n Map key and value if they already exist.
        HouseService -> mainSensorMap: add (sensorFunctionalityID, roomID, deviceID)
        activate mainSensorMap
        deactivate mainSensorMap
    end
HouseService --> HouseService: mainSensorMap
deactivate HouseService
     ref over HouseService
     UC09-SD-ListAllDevicesInHouseByFunctionality-2
     end ref

'END SECTION'
@enduml